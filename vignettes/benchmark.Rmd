---
title: "Benchmarking"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, eval = TRUE, warning = FALSE, message = FALSE,  echo = FALSE}
library(ggplot2)
library(stringr)
library(dplyr)
```


```{r, eval = TRUE, echo = FALSE}

result <- readRDS("../benchmark/results/lm_tbl_df_new.Rds")

N <- 10^7

colors <- scale_color_viridis_d(option = "D")$palette(5)
colors <- c(colors[1], colors[rep(2:4, each = 2)])
names(colors) <- c(
  "lm"
  , "oomlm"
  , "oomlm + resid"
  , "speedlm"
  , "speedlm + resid"
  , "biglm"
  , "biglm + resid"
)
colors[c("oomlm", "oomlm + resid")] <- "#EC8612" #"#DC4749"
nonresid_andlm <- c(T, T, F, T, F, T, F)
includes_resid <- c(T, F, T, F, T, F, T)

df <- result %>% 
  select(expression, min, mean, max, mem_alloc, num_obs) %>%
  dplyr::mutate(
    num_obs       = num_obs / 10^6,
    mem_alloc     = mem_alloc / 10^9,
    nonresid_fit  = (expression %in% (names(colors)[nonresid_andlm])),
    resid_fit     = (expression %in% (names(colors)[includes_resid]))
  )


plot_theme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 18),
    # legend.position = "none",
    legend.title = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
    axis.ticks = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank()
  )

x_format <- function(n) {
  as.character(n/10^6)
}

```



We fit a linear model with 50 features over 2,4,6,8, and 10 million observations.  The code is available [here](https://github.com/blakeboswell/ploom/tree/master/benchmark).

The following functions were included:

- stats `lm()`
- speedglm `speedlm()`
- biglm `biglm()`
- ploom `oomlm()`


## In-Memory

Unlike `lm()`, the functions `speedlm()` `biglm()` and `oomlm()` do not calculate predictions and residuals while the fitting. For greater parity with `lm()`, the benchmark includes a call to `predict()` and a residual calculation for these functions.  

### Runtime

```{r, eval = TRUE, echo = FALSE, fig.width=7, fig.height=3.5}

x <- df %>%
  filter(resid_fit) %>%
  rename(
    lower = min
    , upper = max
  )

x %>%
  arrange(expression) %>%
  ggplot(aes(x = as.factor(num_obs), y = mean, color = expression)) +
  geom_pointrange(aes(ymin = lower, ymax = upper),
                  position = position_dodge(width = 0.25)) +
  scale_y_continuous(
    breaks = scales::pretty_breaks(10)
  ) +
  plot_theme +
  labs(
    x        = "Number of Observations (Million)",
    subtitle = "Mean Runtime (Seconds)"
  ) +
  scale_color_manual(values = colors[includes_resid]) 

```

### Memory Allocated

```{r, eval = TRUE, echo = FALSE, fig.width=7, fig.height=3.5}

x <- df %>%
  filter(resid_fit)

x %>%
  ggplot(aes(x = as.factor(num_obs), y = mem_alloc, color = expression)) +
  geom_point(size = 3, position = position_dodge(width = 0.25)) +
  scale_y_continuous(
    breaks = scales::pretty_breaks(10)
  ) +
  plot_theme +
  labs(
    x        = "Number of Observations (Million)",
    subtitle = "Mean Memory Allocated (gb)"
  ) +
  scale_color_manual(values = colors[includes_resid])

```



